<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>2.1 Quiz Retake</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']]
      },
      svg: { fontCache: 'global' }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .btn-disabled { background-color: #9ca3af; cursor: not-allowed; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="container mx-auto max-w-4xl p-4 sm:p-6 md:p-8">
    <!-- Start Screen -->
    <div id="start-screen">
      <header class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-900">2.1 Quiz Retake</h1>
        <p class="mt-2 text-gray-600">Fourâ€‘Function Calculator Allowed. Enter your name to begin.</p>
      </header>
      <div class="bg-white p-8 rounded-lg shadow-md max-w-md mx-auto">
        <label for="student-name-input" class="block text-sm font-medium text-gray-700">Student Name</label>
        <input id="student-name-input" type="text" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="e.g., Jane Doe"/>
        <button id="start-quiz-btn" class="mt-6 w-full flex justify-center py-3 px-4 rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
          Start Quiz
        </button>
      </div>
    </div>

    <!-- Quiz Screen -->
    <div id="quiz-screen" class="hidden">
      <header class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-900">2.1 Quiz Retake</h1>
        <div class="mt-2 text-gray-600 text-lg">
          Student: <span id="student-name-display" class="font-semibold text-indigo-700"></span>
        </div>
        <div id="score-display" class="mt-1 text-gray-600">Score: 0 / 0 (Total: 6)</div>
        <button id="reset-quiz-btn" class="mt-6 px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-transform transform hover:scale-105">
          Reset This Set
        </button>
      </header>

      <main id="quiz-container" class="space-y-6"></main>

      <div id="completion-container" class="hidden text-center mt-8"></div>
    </div>
  </div>

  <script>
    // ---- STATE ----
    let studentName = '';
    let score = 0;
    let questionsAnswered = 0;

    // ---- DOM ----
    const startScreen = document.getElementById('start-screen');
    const quizScreen = document.getElementById('quiz-screen');
    const studentNameInput = document.getElementById('student-name-input');
    const startQuizBtn = document.getElementById('start-quiz-btn');
    const resetQuizBtn = document.getElementById('reset-quiz-btn');
    const studentNameDisplay = document.getElementById('student-name-display');
    const scoreDisplay = document.getElementById('score-display');
    const quizContainer = document.getElementById('quiz-container');
    const completionContainer = document.getElementById('completion-container');

    // ---- HELPERS ----
    function updateScoreDisplay(total=6) {
      scoreDisplay.textContent = `Score: ${score} / ${questionsAnswered} (Total: ${total})`;
    }

    function parseNumeric(input) {
      // Accepts integers, decimals, or simple fractions a/b (with optional spaces)
      const raw = input.trim().replace(/\\s+/g, '');
      if (/^[-+]?\\d+\\/[-+]?\\d+$/.test(raw)) {
        const [a, b] = raw.split('/').map(Number);
        if (b === 0) return NaN;
        return a / b;
      }
      // plain number
      return Number(raw);
    }

    function nearlyEqual(a, b, eps = 1e-9) {
      return Math.abs(a - b) <= eps;
    }

    function renderFixedQuiz() {
      score = 0;
      questionsAnswered = 0;
      completionContainer.innerHTML = '';
      completionContainer.classList.add('hidden');
      quizContainer.innerHTML = '';

      const questions = [
        {
          qTex: 'Evaluate: $$12-4+6$$',
          value: 14,
          solution: '<p>Compute left to right for addition/subtraction: $12-4=8$, then $8+6=\\boxed{14}$.</p>'
        },
        {
          qTex: 'Evaluate: $$24\\div 4\\cdot 2$$',
          value: 12,
          solution: '<p>Do multiplication/division left to right: $24\\div4=6$, then $6\\cdot2=\\boxed{12}$.</p>'
        },
        {
          qTex: 'Evaluate: $$40-30\\div6\\cdot3-20$$',
          value: 5,
          solution: '<p>Division and multiplication first, left to right: $30\\div6=5$, $5\\cdot3=15$. Then $40-15-20=\\boxed{5}$.</p>'
        },
        {
          qTex: 'Evaluate: $$20-18\\div2+4-3(1-3)\\cdot3^{2}$$',
          value: 69,
          solution: '<p>$18\\div2=9$, $(1-3)=-2$, $3^2=9$, and $3\\cdot(-2)\\cdot9=-54$. So $20-9+4-(-54)=20-9+4+54=\\boxed{69}$.</p>'
        },
        {
          qTex: 'Evaluate: $$\\dfrac{4^{2}-8}{3(7+11)-5}$$',
          value: (16-8) / (3*(7+11) - 5), // This matches the screenshot structure but adjusts denominator to 7+11 to keep value nice if needed.
          // However to stay faithful to the image, use 7+4. Let's override below.
          solution: ''
        },
        {
          qTex: 'Evaluate: $$|3-2^{2}|-|2^{2}-3|$$',
          value: 0,
          solution: '<p>$2^2=4$. Then $|3-4|=1$ and $|4-3|=1$. So $1-1=\\boxed{0}$.</p>'
        }
      ];

      // Correct e) to exactly match the image: (4^2 - 8)/(3(7+4)-5) = 8/28 = 2/7
      questions[4].qTex = 'Evaluate: $$\\dfrac{4^{2}-8}{3(7+4)-5}$$';
      questions[4].value = (16 - 8) / (3*(7+4) - 5); // 8/28 = 2/7
      const fracTex = '\\\\dfrac{2}{7}';
      questions[4].solution = '<p>$4^2=16$, so numerator $16-8=8$. Denominator: $3(7+4)=33$, and $33-5=28$. Thus $\\dfrac{8}{28}=\\dfrac{2}{7}=\\boxed{\\dfrac{2}{7}}$.</p>';

      // Build cards
      questions.forEach((q, idx) => {
        const card = document.createElement('div');
        card.className = 'bg-white p-6 rounded-lg shadow-md';
        card.innerHTML = `
          <div class="flex justify-between items-start">
            <div class="text-lg font-medium text-gray-800 pr-4"><span class="font-bold mr-2">${idx+1}.</span> ${q.qTex}</div>
            <span class="flex-shrink-0 bg-purple-100 text-purple-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Evaluate</span>
          </div>
          <div class="mt-4 flex flex-col sm:flex-row sm:items-center">
            <div class="relative flex-grow">
              <input type="text" id="answer-${idx}" class="w-full pl-4 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="Enter the final value (number or fraction like 2/7)">
            </div>
            <button id="submit-${idx}" class="mt-2 sm:mt-0 sm:ml-2 w-full sm:w-auto px-6 py-2 bg-green-500 text-white font-semibold rounded-md hover:bg-green-600">Submit</button>
          </div>
          <div id="solution-${idx}" class="hidden mt-4 p-4 bg-gray-50 rounded-md border border-gray-200">${q.solution}</div>
        `;
        quizContainer.appendChild(card);

        // Attach handler
        document.getElementById(`submit-${idx}`).addEventListener('click', () => {
          const inputEl = document.getElementById(`answer-${idx}`);
          if (inputEl.disabled) return;
          const userVal = parseNumeric(inputEl.value);
          const correct = parseFloat(q.value);
          const isCorrect = Number.isFinite(userVal) && nearlyEqual(userVal, correct, 1e-6);

          questionsAnswered++;
          if (isCorrect) {
            score++;
            inputEl.classList.add('border-green-500', 'border-2', 'bg-green-50');
          } else {
            inputEl.classList.add('border-red-500', 'border-2', 'bg-red-50');
            const sDiv = document.getElementById(`solution-${idx}`);
            const p = document.createElement('p');
            p.className = 'mt-2 text-red-600 font-semibold';
            p.innerHTML = `Correct answer: <span class="font-bold">${q.value % 1 === 0 ? q.value : '2/7'}</span>`;
            sDiv.prepend(p);
          }

          inputEl.disabled = true;
          const btn = document.getElementById(`submit-${idx}`);
          const sol = document.getElementById(`solution-${idx}`);
          btn.disabled = true; btn.classList.add('btn-disabled');
          sol.classList.remove('hidden');
          MathJax.typesetPromise([`#solution-${idx}`]);
          updateScoreDisplay(questions.length);

          if (questionsAnswered === questions.length && score === questions.length) {
            showCompletion(questions);
          }
        });
      });

      MathJax.typesetPromise();
      updateScoreDisplay(questions.length);
    }

    function showCompletion(questions) {
      completionContainer.classList.remove('hidden');
      completionContainer.innerHTML = `
        <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded-md shadow-lg">
          <h2 class="text-2xl font-bold">Mastery Achieved!</h2>
          <p class="mt-2">Great work! You answered all questions correctly. Download your verification file below.</p>
          <button id="download-score-btn" class="mt-4 px-6 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
            Download Verification File
          </button>
        </div>`;
      document.getElementById('download-score-btn').addEventListener('click', () => downloadScore(questions));
    }

    function downloadScore(questions) {
      const verificationData = {
        studentName: studentName,
        quizTitle: '2.1 Quiz Retake',
        completionDate: new Date().toISOString(),
        masteryAttempt: {
          score: score,
          totalQuestions: 6,
          percentage: 100,
          questions: questions.map((q, i) => ({
            number: i+1,
            question: q.qTex.replace(/\\$\\$/g, ''),
            correctValue: q.value
          }))
        }
      };
      const jsonString = JSON.stringify(verificationData, null, 2);
      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const safeName = studentName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
      a.download = `${safeName}_quiz_2-1_retake.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ---- INIT ----
    startQuizBtn.addEventListener('click', () => {
      const name = studentNameInput.value.trim();
      if (!name) { alert('Please enter your name to start.'); return; }
      studentName = name;
      studentNameDisplay.textContent = studentName;
      startScreen.classList.add('hidden');
      quizScreen.classList.remove('hidden');
      renderFixedQuiz();
    });

    resetQuizBtn.addEventListener('click', () => {
      renderFixedQuiz();
    });
  </script>
</body>
</html>
