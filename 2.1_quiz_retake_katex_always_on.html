<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>2.1 Quiz Retake — Always-On Start</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"></script>

<style>
  :root { --bg:#f5f7fb; --text:#1f2937; --muted:#6b7280; --primary:#3b82f6; --primary-d:#2563eb; --ok:#16a34a; --err:#dc2626; --card:#ffffff; --ring:#93c5fd; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Apple Color Emoji','Segoe UI Emoji'; background: var(--bg); color: var(--text); }
  .container { max-width: 900px; margin: 0 auto; padding: 24px; }
  h1 { margin: 0 0 8px 0; font-size: 28px; }
  .muted { color: var(--muted); }
  .card { background: var(--card); border-radius: 14px; padding: 20px; box-shadow: 0 6px 16px rgba(0,0,0,.08); }
  .btn { display:inline-block; padding: 12px 18px; border-radius: 10px; border: 0; color: #fff; background: var(--primary); cursor: pointer; font-weight: 700; width:100%; }
  .btn:hover { background: var(--primary-d); }
  .btn:disabled { background:#9ca3af; cursor:not-allowed; }
  .field { width: 100%; padding: 10px 12px; border: 1px solid #cbd5e1; border-radius: 10px; outline: none; font-size: 16px; }
  .field:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--ring); }
  .row { display:flex; gap:10px; align-items:center; }
  .row-col { display:flex; flex-direction: column; gap:10px; }
  .mt { margin-top: 16px; }
  .badge { background:#ede9fe; color:#5b21b6; padding:4px 8px; border-radius: 9999px; font-size:12px; font-weight:700; }
  .right { text-align:right; }
  .answer-ok { border:2px solid #16a34a; background:#ecfdf5; }
  .answer-err { border:2px solid #dc2626; background:#fef2f2; }
  .hidden { display:none; }
  .qline { font-size: 20px; font-weight: 600; }
  .math { display:inline-block; font-family: Cambria, 'Times New Roman', serif; }
  .sup { vertical-align: super; font-size: 0.8em; }
  .dot { display:inline-block; transform: translateY(-0.08em); }
  .frac { display:inline-block; vertical-align: middle; text-align:center; }
  .frac .num { padding: 0 0.2em; }
  .frac .den { padding: 0 0.2em; }
  .frac .bar { border-top: 2px solid currentColor; margin: 2px 0; }
  .abs { position: relative; padding: 0 0.35em; }
  .abs:before, .abs:after { content: "|"; position: absolute; top: 0; bottom: 0; font-weight: 700; color: currentColor; }
  .abs:before { left: -0.2em; } .abs:after { right: -0.2em; }
  .paren { font-weight:700; }
  #log { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; background:#0b1020; color:#d1f1ff; padding:10px; border-radius:10px; }
</style>
</head>
<body>
  <div class="container" id="appRoot">
    <div id="start" class="card" role="region" aria-label="Start">
      <h1>2.1 Quiz Retake</h1>
      <p class="muted">Four-Function Calculator Allowed. Enter your name to begin.</p>
      <div class="row-col mt">
        <label for="name" class="muted">Student Name</label>
        <input id="name" class="field" placeholder="e.g., Jane Doe" />
        <button id="go" class="btn mt" onclick="window._startQuiz()">Start Quiz</button>
        <p id="status" class="muted" style="font-size:12px;"></p>
      </div>
    </div>

    <div id="quiz" class="hidden">
      <div class="right muted">Student: <strong id="who"></strong></div>
      <div class="right muted" id="score">Score: 0 / 0 (Total: 6)</div>
      <div class="right"><button id="reset" class="btn" onclick="window._render()">Reset This Set</button></div>
      <div id="qs" class="row-col mt"></div>
      <div id="done" class="hidden mt"></div>
    </div>

    <div class="mt">
      <details open>
        <summary class="muted">Diagnostics</summary>
        <div id="log" class="mt"></div>
      </details>
    </div>
  </div>

<script>
(function(){
  "use strict";
  const logEl = document.getElementById('log');
  function log(msg){ try{ logEl.textContent += msg + "\\n"; }catch(e){} }
  window.addEventListener('error', e => log("Error: " + e.message + " @ " + (e.filename||"") + ":" + (e.lineno||"")));
  window.addEventListener('unhandledrejection', e => log("Promise rejection: " + (e.reason && e.reason.message || e.reason)));

  let studentName = ""; let score = 0; let answered = 0;

  const start = document.getElementById('start');
  const quiz = document.getElementById('quiz');
  const who = document.getElementById('who');
  const nameInput = document.getElementById('name');
  const qs = document.getElementById('qs');
  const done = document.getElementById('done');
  const scoreBox = document.getElementById('score');
  const statusEl = document.getElementById('status');

  function updateScore(total){ scoreBox.textContent = `Score: ${score} / ${answered} (Total: ${total})`; }

  function parseNumeric(s){
    if(!s) return NaN;
    const raw = (""+s).trim().replace(/\\s+/g,'');
    if(/^[-+]?\\d+\\/[-+]?\\d+$/.test(raw)){
      const [a,b] = raw.split('/').map(Number);
      if(b===0) return NaN; return a/b;
    }
    return Number(raw);
  }
  function eq(a,b){ return Math.abs(a-b) <= 1e-9; }

  const Q = [
    { tex:"Evaluate: $$12-4+6$$", html:`Evaluate: <span class="math">12 − 4 + 6</span>`, val:14, sol:`Compute left to right: 12−4=8; 8+6=14.`},
    { tex:"Evaluate: $$24\\\\div 4\\\\cdot 2$$", html:`Evaluate: <span class="math">24 ÷ 4 <span class="dot">·</span> 2</span>`, val:12, sol:`Division then multiplication (left to right): 24÷4=6; 6·2=12.`},
    { tex:"Evaluate: $$40-30\\\\div6\\\\cdot3-20$$", html:`Evaluate: <span class="math">40 − 30 ÷ 6 <span class="dot">·</span> 3 − 20</span>`, val:5, sol:`30÷6=5; 5·3=15; then 40−15−20=5.`},
    { tex:"Evaluate: $$20-18\\\\div2+4-3(1-3)\\\\cdot3^{2}$$", html:`Evaluate: <span class="math">20 − 18 ÷ 2 + 4 − 3<span class="paren">(</span>1−3<span class="paren">)</span> <span class="dot">·</span> 3<span class="sup">2</span></span>`, val:69, sol:`18÷2=9; (1−3)=−2; 3²=9; 3·(−2)·9=−54; 20−9+4−(−54)=69.`},
    { tex:"Evaluate: $$\\\\dfrac{4^{2}-8}{3(7+4)-5}$$", html:`Evaluate: <span class="math"><span class="frac"><span class="num">4<span class="sup">2</span> − 8</span><span class="bar"></span><span class="den">3<span class="paren">(</span>7+4<span class="paren">)</span> − 5</span></span></span>`, val:(16-8)/(3*(7+4)-5), sol:`4²=16 → numerator 8. Denominator: 3(11)=33; 33−5=28; 8/28=2/7.`},
    { tex:"Evaluate: $$|3-2^{2}|-|2^{2}-3|$$", html:`Evaluate: <span class="math"><span class="abs">3 − 2<span class="sup">2</span></span> − <span class="abs">2<span class="sup">2</span> − 3</span></span>`, val:0, sol:`2²=4 → |3−4|=1, |4−3|=1; 1−1=0.`}
  ];

  function renderKatexUpgrade(){
    try{
      if (window.renderMathInElement && window.katex){
        statusEl.textContent = "KaTeX loaded — rendering math.";
        const texContainer = document.createElement('div');
        texContainer.innerHTML = Q.map((q, i) => `<div class="qtex" data-i="${i}">${q.tex}</div>`).join("");
        document.body.appendChild(texContainer);
        window.renderMathInElement(texContainer, { delimiters:[{left:"$$", right:"$$", display:true},{left:"\\(", right:"\\)", display:false}] });
        texContainer.querySelectorAll('.qtex').forEach(div => {
          const i = Number(div.getAttribute('data-i'));
          const qLine = qs.children[i].querySelector('.qline');
          const numberHtml = qLine.querySelector('strong').outerHTML;
          qLine.innerHTML = numberHtml + " " + div.innerHTML;
        });
        texContainer.remove();
      } else {
        statusEl.textContent = "KaTeX not loaded — using offline math display.";
      }
    } catch(err){ log("KaTeX upgrade error: " + err.message); statusEl.textContent = "Math upgrade failed — fallback in use."; }
  }

  // Expose start/render globally for inline onclick
  window._render = function(){
    try{
      score = 0; answered = 0; updateScore(Q.length);
      done.classList.add('hidden'); done.innerHTML = "";
      qs.innerHTML = "";
      // Render fallback HTML first
      Q.forEach((q, i) => {
        const card = document.createElement('div'); card.className = "card mt";
        card.innerHTML = `
          <div class="row" style="justify-content:space-between; align-items:flex-start;">
            <div class="qline"><strong>${i+1}.</strong> ${q.html}</div>
            <span class="badge">Evaluate</span>
          </div>
          <div class="row mt">
            <input id="ans-${i}" class="field" placeholder="Enter number or fraction, e.g., 2/7"/>
            <button id="btn-${i}" class="btn">Submit</button>
          </div>
          <div id="sol-${i}" class="hidden mt muted"></div>
        `;
        qs.appendChild(card);
        // handlers
        const btn = card.querySelector(`#btn-${i}`);
        const field = card.querySelector(`#ans-${i}`);
        const sol = card.querySelector(`#sol-${i}`);
        btn.addEventListener('click', function(){
          const val = parseNumeric(field.value);
          const ok = Number.isFinite(val) && eq(val, q.val);
          answered++;
          if (ok){ score++; field.classList.add('answer-ok'); }
          else { field.classList.add('answer-err'); sol.classList.remove('hidden'); sol.textContent = "Correct answer: " + (Math.abs(q.val - 2/7) < 1e-9 ? "2/7" : q.val); }
          field.disabled = true; btn.disabled = true;
          updateScore(Q.length);
          sol.classList.remove('hidden');
          sol.innerHTML = `<div><strong>Solution:</strong> ${q.sol}</div>`;
          if (answered === Q.length && score === Q.length){ 
            done.innerHTML = `<div class="card"><h2 style="margin:0 0 6px 0;">Mastery Achieved!</h2><p class="muted">Great work! Download verification below.</p><button id="dl" class="btn mt">Download Verification File</button></div>`;
            done.classList.remove('hidden');
            document.getElementById('dl').addEventListener('click', function(){
              const data = { studentName, quizTitle:"2.1 Quiz Retake", completionDate:new Date().toISOString(),
                masteryAttempt:{ score, totalQuestions:Q.length, percentage:100, questions: Q.map((q,i)=>({number:i+1, question:q.tex.replace(/\\$\\$/g,''), correctValue:q.val})) } };
              const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url; a.download = `${studentName.replace(/[^a-z0-9]/gi,'_').toLowerCase()}_quiz_2-1_retake.json`;
              document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
            });
          }
        });
      });
      // Try KaTeX upgrade after a tick
      setTimeout(renderKatexUpgrade, 100);
    } catch(err){ log("Render error: " + err.message); alert("Render failed: " + err.message); }
  };

  window._startQuiz = function(){
    try{
      const n = nameInput.value.trim();
      if(!n){ alert("Please enter your name to start."); return; }
      studentName = n; who.textContent = studentName;
      start.classList.add('hidden'); quiz.classList.remove('hidden');
      statusEl.textContent = "Starting…";
      window._render();
    } catch(err){ log("Start error: " + err.message); alert("Start failed: " + err.message); }
  };

  // Initial status
  document.addEventListener('DOMContentLoaded', function(){
    statusEl.textContent = (window.renderMathInElement && window.katex) ? "KaTeX detected." : "Waiting for KaTeX… (fallback ready)";
  });
  window.addEventListener('load', function(){
    if (!(window.renderMathInElement && window.katex)){
      statusEl.textContent = "KaTeX not detected; using fallback display.";
    }
  });
})();</script>
</body>
</html>
